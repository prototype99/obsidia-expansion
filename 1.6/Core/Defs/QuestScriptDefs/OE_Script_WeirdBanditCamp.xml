<?xml version="1.0" encoding="utf-8" ?>

<Defs>
<!--=============== Quest - Weird Bandit Camp ====================-->
  <QuestScriptDef>
    <defName>OE_Quest_WeirdBanditCamp</defName>
    <rootSelectionWeight>0.9</rootSelectionWeight>
    <rootMinPoints>300</rootMinPoints>
    <canGiveRoyalFavor>true</canGiveRoyalFavor>
    <expireDaysRange>6~7</expireDaysRange>
    <successHistoryEvent MayRequire="Ludeon.RimWorld.Ideology">Raided_BanditCamp</successHistoryEvent>
    <questNameRules>
      <rulesStrings>
        <li>questName->The [bandit] [camp]</li>
        <li>questName->[bandit] [camp]</li>
        <li>questName->[asker_nameDef] and the [camp]</li>
		<li>questName->Strange Discoveries</li>
		<li>questName->Eradicate the Threat</li>
        <li>camp->Camp</li>
        <li>camp->Outpost</li>
        <li>camp->Lair</li>
        <li>camp->Encampment</li>
        <li>bandit->Bandit</li>
        <li>bandit->Raider</li>
        <li>bandit->Outlaw</li>
        <li>bandit->Marauder</li>
        <li>bandit->Robber</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->[asker_nameFull], [asker_faction_leaderTitle] of [asker_faction_name], reports that their reconnaissance on Crimson Arachna Cult activity has uncovered something unusual. Their scouts followed suspicious tracks that led to a strange camp near our location, controlled by [siteFaction_name].\n\n[asker_nameDef] requests our help to eliminate the camp, destroying all enemies and defenses to stop whatever the Crimson Arachna Cult may be planning. [asker_label] says that [sitePart0_description].</li>
		<li>questDescription->[asker_nameFull], [asker_faction_leaderTitle] of [asker_faction_name], has shared disturbing news. Their reconnaissance of the Crimson Arachna Cult's movements uncovered a shadowy camp hidden nearby. The tracks they followed led straight to [siteFaction_name], who seems to be plotting something sinister.\n\n[asker_label] urges us to strike first, eradicating the camp before whatever darkness stirs there can be unleashed. [asker_label] says that [sitePart0_description].</li>
      </rulesStrings>
    </questDescriptionRules>
    <root Class="QuestNode_Sequence">
      <nodes>
        <li Class="QuestNode_SubScript">
          <def>Util_RandomizePointsChallengeRating</def>
          <parms>
            <pointsFactorTwoStar>1.5</pointsFactorTwoStar>
            <pointsFactorThreeStar>2.0</pointsFactorThreeStar>
          </parms>
        </li>
        <li Class="QuestNode_GetMap" />
		
		<!-- Generate Asker -->
		<li Class="QuestNode_RandomNode">
          <nodes>
            <li Class="QuestNode_GetPawn">
              <storeAs>asker</storeAs>
			  <mustBeOfKind>OMC_Officer_CallAid</mustBeOfKind>
              <mustBeFactionLeader>false</mustBeFactionLeader>
              <mustBeNonHostileToPlayer>false</mustBeNonHostileToPlayer>
              <hostileWeight>0.15</hostileWeight>
              <selectionWeight>0.2</selectionWeight>
            </li>
			<li Class="QuestNode_GetPawn">
              <storeAs>asker</storeAs>
			  <mustBeOfKind>ODC_Leader_Boss</mustBeOfKind>
              <mustBeFactionLeader>true</mustBeFactionLeader>
              <mustBeNonHostileToPlayer>false</mustBeNonHostileToPlayer>
              <hostileWeight>0.15</hostileWeight>
              <selectionWeight>0.2</selectionWeight>
            </li>
			<li Class="QuestNode_GetPawn">
              <storeAs>asker</storeAs>
			  <mustBeOfKind>ODC_Leader_Mayor</mustBeOfKind>
              <mustBeFactionLeader>true</mustBeFactionLeader>
              <mustBeNonHostileToPlayer>true</mustBeNonHostileToPlayer>
              <hostileWeight>0.15</hostileWeight>
              <selectionWeight>0.2</selectionWeight>
            </li>
			<li Class="QuestNode_GetPawn">
              <storeAs>asker</storeAs>
			  <mustBeOfKind>ODC_Leader_Admiral</mustBeOfKind>
              <mustBeFactionLeader>true</mustBeFactionLeader>
              <mustBeNonHostileToPlayer>true</mustBeNonHostileToPlayer>
              <hostileWeight>0.15</hostileWeight>
              <selectionWeight>0.2</selectionWeight>
            </li>
			<li Class="QuestNode_GetPawn">
              <storeAs>asker</storeAs>
			  <mustBeOfKind>OMG_Kingpin</mustBeOfKind>
              <mustBeFactionLeader>true</mustBeFactionLeader>
              <mustBeNonHostileToPlayer>true</mustBeNonHostileToPlayer>
              <hostileWeight>0.15</hostileWeight>
              <selectionWeight>0.2</selectionWeight>
            </li>
          </nodes>
        </li>

        <li Class="QuestNode_GetSiteTile">
          <storeAs>siteTile</storeAs>
          <preferCloserTiles>true</preferCloserTiles>
		  <selectLandmarkChance>0.2</selectLandmarkChance>
          <allowedLandmarks>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Oasis</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Lake</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">LakeWithIsland</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">LakeWithIslands</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Pond</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">DryLake</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">ToxicLake</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Wetland</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">HotSprings</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Archipelago</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">CoastalIsland</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Peninsula</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Bay</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Fjord</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">CoastalAtoll</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Valley</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Cavern</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Chasm</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Crevasse</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Plateau</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">IceDunes</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Cliffs</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Hollow</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Basin</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">TerraformingScar</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">LavaLake</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">LavaCrater</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">LavaFlow</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Dunes</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Ruins</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">FrozenRuins</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientSmokeVent</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientToxVent</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientHeatVent</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientQuarry</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AbandonedColonyTribal</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AbandonedColonyOutlander</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientLaunchSite</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">Harbor</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientGarrison</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientWarehouse</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientChemfuelRefinery</li>
            <li MayRequire="Ludeon.RimWorld.Odyssey">AncientInfestedSettlement</li>
          </allowedLandmarks>
        </li>

        <li Class="QuestNode_GetSitePartDefsByTagsAndFaction">
          <storeAs>sitePartDefs</storeAs>
          <storeFactionAs>siteFaction</storeFactionAs>
          <sitePartsTags>
            <li>
			  <tag>BanditCamp</tag>
			</li>
			<li>
              <tag>ItemStash</tag>
            </li>
          </sitePartsTags>
          <mustBeHostileToFactionOf>$asker</mustBeHostileToFactionOf>
        </li>

        <li Class="QuestNode_GetDefaultSitePartsParams">
          <tile>$siteTile</tile>
          <faction>$siteFaction</faction>
          <sitePartDefs>$sitePartDefs</sitePartDefs>
          <storeSitePartsParamsAs>sitePartsParams</storeSitePartsParamsAs>
        </li>
        
        <li Class="QuestNode_GetSiteThreatPoints">
          <storeAs>sitePoints</storeAs>
          <sitePartsParams>$sitePartsParams</sitePartsParams>
        </li>
        <li Class="QuestNode_SubScript">
          <def>Util_GetDefaultRewardValueFromPoints</def>
          <parms>
            <!-- Use the actual threat points generated (some site parts define a minimum threshold) -->
            <points>$sitePoints</points>
          </parms>
        </li>
		
		<!-- Raid -->
        <li Class="QuestNode_Set">
          <name>raidDelayTicks</name>
          <value>$(roundToTicksRough(randInt(45000, 75000)))</value>
        </li>
        <li Class="QuestNode_Delay">
          <delayTicks>$raidDelayTicks</delayTicks>
          <node Class="QuestNode_SubScript">
            <def>Util_Raid</def>
            <prefix>raid</prefix>
            <parms>
              <inSignal>$inSignal</inSignal>
              <map>$map</map>
              <enemyFaction>ObsidiaCrimsonArachnaCult</enemyFaction>
              <points>$sitePoints</points>
              <walkInSpot>$walkInSpot</walkInSpot>
              <customLetterLabel TKey="LetterLabelLoyaltySquad">{BASELABEL}: Loyalty squad</customLetterLabel>
              <customLetterText TKey="LetterTextLoyaltySquad">{BASETEXT}\n\nA cultist squad intercepted our messages, obtained our camp’s coordinates, and is now heading toward our settlement.
              </customLetterText>
            </parms>
          </node>
        </li>

        <!-- Inflate reward value. Since we're basing the reward value on the threat points generated, we need to do this
             even though the threat points was deflated from the input points already. -->
        <li Class="QuestNode_Multiply">
            <value1>$rewardValue</value1>
            <value2>2.0</value2>
            <storeAs>rewardValue</storeAs>
        </li>

        <li Class="QuestNode_SubScript">
          <def>Util_GenerateSite</def>
        </li>
        
        <li Class="QuestNode_SpawnWorldObjects">
          <worldObjects>$site</worldObjects>
        </li>

        <!-- - - - - - - -  -->
        <!-- End conditions -->
        <!-- - - - - - - -  -->

        <!-- Bandit camp moved -->
		<li Class="QuestNode_WorldObjectTimeout">
          <worldObject>$site</worldObject>
          <isQuestTimeout>true</isQuestTimeout>
          <delayTicks>$(randInt(12,28)*60000)</delayTicks>
          <inSignalDisable>site.MapGenerated</inSignalDisable>
          <destroyOnCleanup>true</destroyOnCleanup>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label TKey="LetterLabelQuestExpired">Quest expired: [resolvedQuestName]</label>
                <text TKey="LetterTextQuestExpired">The bandit camp has packed up and moved on. The quest [resolvedQuestName] has expired.</text>
              </li>
              <li Class="QuestNode_End">
                <outcome>Fail</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <!-- If we enter and leave, the map is destroyed. Fail the quest. -->
        <li Class="QuestNode_Signal">
          <inSignal>site.Destroyed</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label TKey="LetterLabelQuestFailed">Quest failed: [resolvedQuestName]</label>
                <text TKey="LetterTextQuestFailed">After being discovered, the bandit camp has dispersed. The quest [resolvedQuestName] has ended.</text>
              </li>
              <li Class="QuestNode_End">
                <outcome>Fail</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <!-- Complete -->
		<li Class="QuestNode_Signal">
          <inSignal>site.AllEnemiesDefeated</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Notify_PlayerRaidedSomeone">
                <getRaidersFromMapParent>$site</getRaidersFromMapParent>
              </li>
              <li Class="QuestNode_GiveRewards">
                <parms>
                  <allowGoodwill>true</allowGoodwill>
                  <allowRoyalFavor>true</allowRoyalFavor>
                  <chosenPawnSignal>ChosenPawnForReward</chosenPawnSignal>
                </parms>
                <addCampLootReward>true</addCampLootReward>
                <customLetterLabel TKey="LetterLabelPaymentArrived">Payment arrived</customLetterLabel>
                <customLetterText TKey="LetterTextPaymentArrived">You have defeated the bandit camp!\n\nThe payment from [asker_faction_name] has arrived.</customLetterText>
                <nodeIfChosenPawnSignalUsed Class="QuestNode_Letter">
                  <letterDef>ChoosePawn</letterDef>
                  <label TKey="LetterLabelFavorReceiver">[asker_faction_royalFavorLabel]</label>
                  <text TKey="LetterTextFavorReceiver">These colonists participated in the victory for the quest [resolvedQuestName]. [asker_definite] wants to know who should receive the [royalFavorReward_amount] [asker_faction_royalFavorLabel] for this service.</text>
                  <useColonistsOnMap>$site</useColonistsOnMap>
                  <chosenPawnSignal>ChosenPawnForReward</chosenPawnSignal>
                </nodeIfChosenPawnSignalUsed>
              </li>
            </nodes>
          </node>
        </li>
        <li Class="QuestNode_End">
          <inSignal>site.AllEnemiesDefeated</inSignal>
          <outcome>Success</outcome>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>

</Defs>